<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Localhost Port Probe — Auto Fetch Only</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,Arial;margin:18px;background:#fafafa;color:#111}
    h1{font-size:18px;margin-bottom:6px}
    #status{margin-bottom:10px;color:#444}
    #openList{margin-top:12px}
    .portItem{padding:10px;border-radius:6px;background:#fff;border:1px solid #e8e8e8;margin-bottom:8px;display:flex;gap:12px;align-items:center}
    .method{font-weight:700;color:#0a7}
    .note{color:#666;margin-left:auto;font-size:13px}
    #spinner{display:inline-block;width:14px;height:14px;border:3px solid #ddd;border-top-color:#333;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <h1>Localhost Port Probe — Auto (Fetch Only)</h1>
  <div id="status"><span id="spinner"></span>Scanning common ports on <b>127.0.0.1</b>...</div>
  <div id="openList" aria-live="polite"></div>

<script>
(async function(){
  // --- Common ports to test ---
  const COMMON_PORTS = [
    21,22,23,25,53,80,110,143,443,445,
    465,587,631,993,995,1080,1433,1521,1723,
    1883,2375,3000,3306,3389,5000,5060,5432,
    5601,5900,6379,6380,6443,6667,7000,8000,
    8080,8081,8088,8443,8500,8888,9000,9090,9200,
    9300,9999,11211,27017,50070,50075
  ];

  const HOST = '127.0.0.1';
  const CONCURRENCY = 150;
  const TIMEOUT_MS = 900;

  const statusEl = document.getElementById('status');
  const spinner = document.getElementById('spinner');
  const openListEl = document.getElementById('openList');

  function addOpen(port, note, took) {
    const el = document.createElement('div');
    el.className = 'portItem';
    el.innerHTML = `<span class="method">HTTP</span> port <b>${port}</b> <span class="note">${note} — ${took}ms</span>`;
    openListEl.appendChild(el);
  }

  function setStatus(txt) {
    statusEl.innerHTML = `<span id="spinner" style="display:inline-block;width:14px;height:14px;border:3px solid #ddd;border-top-color:#333;border-radius:50%;animation:spin 1s linear infinite;vertical-align:middle;margin-right:8px"></span>${txt}`;
  }

  function withTimeout(promise, ms) {
    return Promise.race([
      promise,
      new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
    ]);
  }

  async function probeFetch(host, port, timeoutMs) {
    const rnd = Math.floor(Math.random()*1e9);
    const url = `http://${host}:${port}/?__probe=${rnd}`;
    const start = performance.now();
    try {
      await withTimeout(fetch(url, { mode:'no-cors', cache:'no-store' }), timeoutMs);
      return { ok: true, note: 'fetch resolved', took: Math.round(performance.now()-start) };
    } catch {
      return { ok: false };
    }
  }

  async function chunkedScan(host, ports, concurrency, timeoutMs) {
    const results = [];
    for (let i = 0; i < ports.length; i += concurrency) {
      const batch = ports.slice(i, i + concurrency);
      const promises = batch.map(p =>
        probeFetch(host, p, timeoutMs).then(r => ({ port: p, ...r }))
      );
      const settled = await Promise.all(promises);
      for (const s of settled) {
        if (s.ok) {
          addOpen(s.port, s.note, s.took);
          results.push(s);
        }
      }
      setStatus(`Scanning ${Math.min(i+concurrency, ports.length)}/${ports.length} ports — found ${results.length} open`);
      await new Promise(r => setTimeout(r, 25));
    }
    return results;
  }

  // Run automatically
  const found = await chunkedScan(HOST, COMMON_PORTS, CONCURRENCY, TIMEOUT_MS);
  spinner.style.display = 'none';
  setStatus(`Scan complete — ${found.length} open port(s) detected on ${HOST}.`);
})();
</script>
</body>
</html>
