<!-- Save as receiver.html -->
<!DOCTYPE html>
<html>

<head>
  <title>Vulnerable PostMessage - Reflection</title>
</head>

<body>
  <h1>PostMessage Reflection Demo</h1>
  <div id="output"></div>

  <!-- âš ï¸ No origin check â€” vulnerable to simple XSS -->
  <script>
    window.addEventListener("message", function (event) {
      document.getElementById("output").innerHTML = event.data;
    });
  </script>

  <!-- âš ï¸ Sends token to whoever asks -->
  <script>
    const token = "super_secret_token_12345";
    window.addEventListener("message", function (event) {
      if (event.data === "getToken") {
        event.source.postMessage("Your token is: " + token, event.origin);
      }
    });
  </script>

  <!-- âš ï¸ No verification of source or user -->
  <script>
    let isAdmin = false;

    window.addEventListener("message", function (event) {
      if (event.data.action === "setAdmin") {
        isAdmin = true;
        alert("Admin privileges granted!");
      }
    });
  </script>

  <!-- ðŸ§¨ BAD: origin check exists, but it's meaningless -->
  <script>
    window.addEventListener("message", function (event) {
      if (event.origin === "*" || event.origin) {
        document.getElementById("output").innerHTML = event.data;
      }
    });
  </script>


  <!-- ðŸ§¨ Logic flaw: allows subdomain spoofing -->
  <script>
    const allowedOrigins = [
      "https://secure.example.com"
    ];

    window.addEventListener("message", function (event) {
      if (allowedOrigins.some(origin => event.origin.endsWith("example.com"))) {
        document.body.innerHTML = event.data;
      }
    });
  </script>

  <!-- ðŸ§¨ Still vulnerable if the trusted site gets compromised or loads attacker content -->
  <script>
    const allowedOrigin = "https://trusted.example.com";

    window.addEventListener("message", function (event) {
      if (event.origin === allowedOrigin) {
        document.getElementById("output").innerHTML = event.data;
      }
    });
  </script>

  <!-- ðŸ§¨ Bad sanitization -->
  <script>
    function sanitize(input) {
      return input.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    window.addEventListener("message", function (event) {
      if (event.origin === "https://safe.com") {
        const sanitized = sanitize(event.data);
        document.getElementById("output").innerHTML = sanitized;
      }
    });
  </script>

  <!-- ðŸ§¨ Parses attacker input -->
  <script>
    window.addEventListener("message", function (event) {
      try {
        const data = JSON.parse(event.data);
        document.getElementById("output").innerHTML = data.html;
      } catch (e) {
        console.error("Malformed JSON");
      }
    });
  </script>

</body>

</html>